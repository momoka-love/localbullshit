<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Bullshit Game</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
  body { font-family:sans-serif; margin:0; padding:0; background:#0f1724; color:#fff; }
  #lobby-container, #game-container-wrapper { padding:20px; }
  #game-container-wrapper { display:none; }
  .card { display:inline-block; margin:4px; padding:12px; background:#fff; color:#000; border-radius:8px; cursor:pointer; }
  .selected { transform:translateY(-5px); border:2px solid #4fd1c5; }
  #pile-container .pile-card { margin:2px 0; background:#ddd; color:#000; padding:4px; border-radius:6px; }
  #bs-banner { display:none; background:#ff6b6b; color:#fff; padding:10px; margin:10px 0; border-radius:6px; text-align:center; }
  button { margin:4px; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; }
</style>
</head>
<body>

<div id="lobby-container">
  <h2>Join Lobby</h2>
  <input id="player-name" placeholder="Your name">
  <input id="lobby-name" placeholder="Lobby name">
  <button id="btn-join">Join</button>
</div>

<div id="game-container-wrapper">
  <div id="bs-banner"></div>

  <h3>Your Hand</h3>
  <div id="game-container"></div>

  <h3>Pile</h3>
  <div id="pile-container"></div>

  <h3>Players</h3>
  <ul id="players-list"></ul>

  <div id="game-info"></div>

  <button id="btn-play">Play Selected</button>
  <button id="btn-draw">Draw</button>
  <button id="btn-bullshit">Call Bullshit</button>
  <button id="btn-leave">Leave Lobby</button>
</div>

<script>
// Firebase setup
const firebaseConfig = {
  apiKey: "AIzaSyDuRUwCmQCoSJTMvwqaY4Hj-SPv4WCHWpQ",
  authDomain: "bullshit-f4f8e.firebaseapp.com",
  databaseURL: "https://bullshit-f4f8e-default-rtdb.firebaseio.com",
  projectId: "bullshit-f4f8e",
  storageBucket: "bullshit-f4f8e.appspot.com",
  messagingSenderId: "497908378251",
  appId: "1:497908378251:web:8f93b8a4d1d27539b2c28e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Game variables
const suits = ['♠','♥','♦','♣'];
const ranks = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];

let playerName="", lobbyName="", lobbyRef=null, messagesRef=null;
let playerHand=[], pile=[], currentTurn="", joined=false;
let selectedCards=new Set();
let lobbyUnsub=null;

// Utilities
function randomCard(){ return ranks[Math.floor(Math.random()*ranks.length)] + suits[Math.floor(Math.random()*suits.length)]; }
function getNextRank(lastRank){ if(!lastRank) return ranks[0]; return ranks[(ranks.indexOf(lastRank)+1)%ranks.length]; }

// Visual Bullshit banner
function showBullshitBanner(msg){
  const banner=document.getElementById('bs-banner');
  banner.textContent=msg;
  banner.style.display='block';
  setTimeout(()=>{ banner.style.display='none'; }, 2000);
}

// Join lobby
async function joinLobby(){
  playerName=document.getElementById('player-name').value.trim();
  lobbyName=document.getElementById('lobby-name').value.trim();
  if(!playerName||!lobbyName){ alert("Enter name and lobby"); return; }

  lobbyRef=db.ref('lobbies/'+lobbyName);

  try{
    await lobbyRef.transaction(game=>{
      if(!game) game={players:{}, pile:[], currentTurn:playerName, winner:null};
      game.players=game.players||{};
      if(!game.players[playerName]) game.players[playerName]=Array.from({length:5},()=>randomCard());
      playerHand=game.players[playerName].slice();
      game.currentTurn=game.currentTurn||playerName;
      return game;
    });

    joined=true;
    document.getElementById('lobby-container').style.display='none';
    document.getElementById('game-container-wrapper').style.display='block';

    if(lobbyUnsub) lobbyRef.off('value', lobbyUnsub);
    lobbyUnsub=lobbyRef.on('value', snapshot=>{
      const game=snapshot.val()||{};
      pile=game.pile||[];
      currentTurn=game.currentTurn||"";
      if(game.players&&game.players[playerName]) playerHand=game.players[playerName].slice();
      updateUI(game.players||{}, game.winner||null);
      if(game.winner) showBullshitBanner(`${game.winner} wins!`);
    });

  }catch(err){ console.error(err); alert("Failed to join: "+err.message);}
}

// Toggle card
function toggleCard(idx){ if(selectedCards.has(idx)) selectedCards.delete(idx); else selectedCards.add(idx); updateUI(); }

// Play selected
async function playSelected(){
  if(!joined||selectedCards.size===0||currentTurn!==playerName) return;
  const indices=[...selectedCards].sort((a,b)=>a-b);
  const cardsPreview=indices.map(i=>playerHand[i]);
  const lastDeclared=pile.length?pile[pile.length-1].declared:null;
  const requiredDeclared=getNextRank(lastDeclared);
  let declared=prompt(`Declare rank:`, requiredDeclared || cardsPreview[0].slice(0,-1)) || requiredDeclared;
  declared=declared.trim();
  if(requiredDeclared && declared!==requiredDeclared){ alert(`Must declare ${requiredDeclared}`); return; }

  await lobbyRef.transaction(game=>{
    if(!game) return game;
    if(game.currentTurn!==playerName) return game;
    const hand=game.players[playerName].slice();
    if(indices.some(i=>i<0||i>=hand.length)) return game;
    const played=indices.map(i=>hand[i]);
    game.players[playerName]=hand.filter((_,i)=>!indices.includes(i));
    played.forEach(c=>game.pile.push({card:c, declared, player:playerName}));
    if(game.players[playerName].length===0) game.winner=playerName;
    const allPlayers=Object.keys(game.players).sort();
    if(allPlayers.length>0){ let idx=allPlayers.indexOf(game.currentTurn); if(idx===-1) idx=0; game.currentTurn=allPlayers[(idx+1)%allPlayers.length]; } else game.currentTurn=null;
    return game;
  });
  selectedCards.clear();
}

// Draw card
async function drawCard(){
  if(!joined||currentTurn!==playerName) return;
  const newCard=randomCard();
  await lobbyRef.child('players').child(playerName).transaction(hand=>{ hand=hand||[]; hand.push(newCard); return hand; });
}

// Call Bullshit
async function callBS(){
  if(!joined||pile.length===0) return;
  await lobbyRef.transaction(game=>{
    if(!game||!game.pile) return game;
    const last=game.pile[game.pile.length-1];
    const pileCards=game.pile.map(p=>p.card);
    game.players=game.players||{};
    if(last.card.slice(0,-1)===last.declared) game.players[playerName]=(game.players[playerName]||[]).concat(pileCards);
    else game.players[last.player]=(game.players[last.player]||[]).concat(pileCards);
    game.pile=[];
    game.currentTurn=playerName;
    return game;
  });
  showBullshitBanner("BULLSHIT called!");
}

// Leave lobby
async function leaveLobby(){
  if(!joined) return;
  await lobbyRef.child('players').child(playerName).remove();
  joined=false;
  playerName=""; lobbyName=""; playerHand=[]; pile=[]; currentTurn="";
  document.getElementById('game-container-wrapper').style.display='none';
  document.getElementById('lobby-container').style.display='block';
}

// Update UI
function updateUI(players={}, winner=null){
  const container=document.getElementById('game-container');
  container.innerHTML='';
  playerHand.forEach((c,i)=>{
    const div=document.createElement('div');
    div.textContent=c; div.className='card';
    if(selectedCards.has(i)) div.classList.add('selected');
    div.onclick=()=>toggleCard(i);
    container.appendChild(div);
  });

  const pileContainer=document.getElementById('pile-container');
  pileContainer.innerHTML='';
  pile.forEach((p,i)=>{
    const div=document.createElement('div');
    div.textContent=(p.player===playerName)?`${p.card} (${p.declared})`:`${p.declared} (by ${p.player})`;
    div.className='pile-card';
    pileContainer.appendChild(div);
  });

  const list=document.getElementById('players-list');
  list.innerHTML='';
  Object.entries(players).forEach(([name,hand])=>{
    const li=document.createElement('li');
    li.textContent=`${name} - ${hand.length} card${hand.length!==1?'s':''}`;
    if(name===currentTurn) li.style.fontWeight='bold';
    if(hand.length===0) li.style.textDecoration='underline';
    list.appendChild(li);
  });

  document.getElementById('game-info').textContent=`Current Turn: ${currentTurn}`;

  document.getElementById('btn-play').disabled=!joined||currentTurn!==playerName||winner;
  document.getElementById('btn-draw').disabled=!joined||currentTurn!==playerName||winner;
  document.getElementById('btn-bullshit').disabled=!joined||pile.length===0||winner;
}

// Event listeners
document.getElementById('btn-join').onclick=joinLobby;
document.getElementById('btn-play').onclick=playSelected;
document.getElementById('btn-draw').onclick=drawCard;
document.getElementById('btn-bullshit').onclick=callBS;
document.getElementById('btn-leave').onclick=leaveLobby;
</script>

</body>
</html>
