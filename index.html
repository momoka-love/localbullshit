<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>bullshit!</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
<style>
  /* --- Styles same as before (UI + debug) --- */
  :root{
    --pink-1: #fff0f6;
    --pink-2: #ffd6e7;
    --accent: #ff84b1;
    --muted: #8f6b83;
    --white: #ffffff;
    --card-shadow: 0 8px 20px rgba(168, 92, 125, 0.12);
  }
  html, body { margin:0; padding:0; height:100%; font-family:"Poppins",sans-serif; background:linear-gradient(180deg,var(--pink-1),var(--pink-2)); color:#53324b; }
  .app { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px; }
  .card-shell{ width:100%; max-width:1100px; background:rgba(255,255,255,0.9); border-radius:20px; padding:22px; }
  header.app-header{ display:flex; justify-content:space-between; align-items:center; }
  .logo{ display:flex; gap:12px; align-items:center; }
  .logo .mark{ width:56px; height:56px; border-radius:12px; background:#ff69a8; color:white; display:flex; align-items:center; justify-content:center; font-weight:700; }
  #lobby-container{ margin:20px 0; }
  input{ padding:8px; border-radius:8px; border:1px solid #ccc; }
  button{ padding:10px 14px; border:none; border-radius:10px; cursor:pointer; background:#ff69a8; color:white; font-weight:600; }
  button.secondary{ background:#ddd; color:#333; }
  .board{ display:flex; gap:18px; flex-wrap:wrap; }
  .left{ flex:1 1 60%; background:white; border-radius:14px; padding:16px; }
  #game-container{ display:flex; flex-wrap:wrap; gap:10px; }
  .card{ background:#fff; border:1px solid #ccc; padding:10px; border-radius:8px; cursor:pointer; }
  .card.selected{ background:#ffe6f0; border:2px solid #ff69a8; }
  .controls{ margin-top:12px; display:flex; gap:8px; }
  .right{ flex:1 1 30%; }
  #btn-debug{ position:fixed; top:10px; right:10px; background:#333; color:#fff; padding:8px 14px; border-radius:6px; z-index:10000; }
  #debug-panel{ position:fixed; bottom:0; left:0; width:100%; max-height:200px; overflow-y:auto; background:rgba(0,0,0,0.85); color:#0f0; font-family:monospace; font-size:12px; padding:4px; z-index:10000; display:none; }
  #bs-banner{ position:fixed; left:50%; transform:translateX(-50%); top:20px; background:#ff5aa0; color:white; padding:10px 18px; border-radius:20px; font-weight:700; display:none; z-index:9999; }
</style>
</head>
<body>
<button id="btn-debug">debug: off</button>
<div id="debug-panel"></div>
<div id="bs-banner">bullshit!</div>

<div class="app">
  <div class="card-shell">
    <header class="app-header">
      <div class="logo"><div class="mark">BS!</div><h1>Bullshit!</h1></div>
      <button class="secondary" id="btn-leave">Leave</button>
    </header>

    <div id="lobby-container">
      <input id="player-name" type="text" placeholder="your name">
      <input id="lobby-name" type="text" placeholder="lobby name">
      <button id="btn-join">join lobby</button>
    </div>

    <div id="game-container-wrapper" style="display:none;">
      <div class="board">
        <div class="left">
          <div id="game-info">current Turn: —</div>
          <div id="game-container"></div>
          <div class="controls">
            <button id="btn-play">play</button>
            <button id="btn-draw" class="secondary">draw</button>
            <button id="btn-bullshit">bullshit!</button>
          </div>
        </div>
        <div class="right">
          <h3>pile</h3><div id="pile-container"></div>
          <h3>players</h3><ul id="players-list"></ul>
          <h3>chat</h3>
          <div id="chat-container"></div>
          <input id="chat-input" placeholder="type message"><button id="chat-send">send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
/* ---------------- Debug Setup ---------------- */
let debugEnabled = false;
function debugLog(...args){
  if(!debugEnabled) return;
  const panel=document.getElementById('debug-panel');
  panel.style.display='block';
  const msg=document.createElement('div');
  msg.textContent=args.map(a=>typeof a==="object"?JSON.stringify(a):a).join(" ");
  panel.appendChild(msg);
  panel.scrollTop=panel.scrollHeight;
}
window.onerror=(msg,src,line,col)=>{debugLog("ERROR:",msg,"at",line+":"+col);};
document.getElementById('btn-debug').onclick=()=>{
  debugEnabled=!debugEnabled;
  firebase.database.enableLogging(debugEnabled?debugLog:false);
  document.getElementById('btn-debug').textContent=debugEnabled?"debug: on":"debug: off";
  debugLog("debug logging is now",debugEnabled?"on":"ogg");
};

/* ---------------- Firebase Init ---------------- */
const firebaseConfig={
  apiKey:"AIzaSyDuRUwCmQCoSJTMvwqaY4Hj-SPv4WCHWpQ",
  authDomain:"bullshit-f4f8e.firebaseapp.com",
  databaseURL:"https://bullshit-f4f8e-default-rtdb.firebaseio.com",
  projectId:"bullshit-f4f8e",
  storageBucket:"bullshit-f4f8e.appspot.com",
  messagingSenderId:"497908378251",
  appId:"1:497908378251:web:8f93b8a4d1d27539b2c28e"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

/* ---------------- Game Logic ---------------- */
const suits=['♠','♥','♦','♣'];
const ranks=['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
let playerName="",lobbyName="",lobbyRef=null,playerHand=[],pile=[],currentTurn="",joined=false,selectedCards=new Set(),lobbyUnsub=null,chatRef=null,chatUnsub=null;

function randomCard(){return ranks[Math.floor(Math.random()*ranks.length)]+suits[Math.floor(Math.random()*suits.length)];}
function getNextRank(last){const idx=ranks.indexOf(last);return idx===-1?null:ranks[(idx+1)%ranks.length];}
function showBullshitBanner(msg){const b=document.getElementById('bs-banner');b.textContent=msg;b.style.display='block';setTimeout(()=>b.style.display='none',2000);}

async function joinLobby(){
  playerName=document.getElementById('player-name').value.trim();
  lobbyName=document.getElementById('lobby-name').value.trim();
  if(!playerName||!lobbyName){alert("Enter name and lobby");return;}
  lobbyRef=db.ref('lobbies/'+lobbyName);
  await lobbyRef.transaction(game=>{
    if(!game)game={players:{},pile:[],currentTurn:playerName,winner:null};
    if(!game.players[playerName])game.players[playerName]=Array.from({length:5},()=>randomCard());
    return game;
  });
  joined=true;
  document.getElementById('lobby-container').style.display='none';
  document.getElementById('game-container-wrapper').style.display='block';
  if(lobbyUnsub) lobbyRef.off('value',lobbyUnsub);
  lobbyUnsub=lobbyRef.on('value',snap=>{
    const game=snap.val()||{};
    pile=game.pile||[]; currentTurn=game.currentTurn||"";
    if(game.players&&game.players[playerName])playerHand=game.players[playerName];
    updateUI(game.players||{},game.winner);
    if(game.winner)showBullshitBanner(`${game.winner} wins!`);
  });
  chatRef=lobbyRef.child('chat');
  if(chatUnsub)chatRef.off('child_added',chatUnsub);
  chatUnsub=chatRef.on('child_added',snap=>appendChatMessage(snap.val()));
}

function toggleCard(i){if(selectedCards.has(i))selectedCards.delete(i);else selectedCards.add(i);updateUI();}
async function playSelected(){
  if(!joined||selectedCards.size===0||currentTurn!==playerName)return;
  const indices=[...selectedCards].sort((a,b)=>b-a);
  const last=pile.length?pile[pile.length-1].declared:null;
  const required=last?getNextRank(last):null;
  let declared=prompt(required?`Declare ${required}`:"Declare rank",required||playerHand[indices[0]].slice(0,-1));
  if(!declared)return;
  declared=declared.toUpperCase();
  if(required&&declared!==required){alert(`You must declare ${required}`);return;}
  await lobbyRef.transaction(game=>{
    if(!game||game.currentTurn!==playerName)return game;
    const hand=game.players[playerName]; const played=[];
    indices.forEach(i=>{if(i>=0&&i<hand.length){played.push(hand[i]);hand.splice(i,1);}});
    played.forEach(c=>game.pile.push({card:c,declared,player:playerName}));
    if(hand.length===0)game.winner=playerName;
    const players=Object.keys(game.players);
    let idx=players.indexOf(playerName);
    game.currentTurn=players[(idx+1)%players.length];
    return game;
  });
  selectedCards.clear();
}
async function drawCard(){
  if(!joined||currentTurn!==playerName)return;
  const card=randomCard();
  await lobbyRef.child('players').child(playerName).transaction(h=>(h||[]).concat(card));
}
async function callBS(){
  if(!joined||pile.length===0)return;
  await lobbyRef.transaction(game=>{
    if(!game||!game.pile)return game;
    const last=game.pile[game.pile.length-1];
    const pileCards=game.pile.map(p=>p.card);
    if(last.card.slice(0,-1).toUpperCase()===last.declared.toUpperCase()){
      game.players[playerName]=game.players[playerName].concat(pileCards);
    } else {
      game.players[last.player]=game.players[last.player].concat(pileCards);
    }
    game.pile=[]; game.currentTurn=playerName; return game;
  });
  showBullshitBanner("bullshit!");
}
async function leaveLobby(){
  if(!joined)return;
  await lobbyRef.child('players').child(playerName).remove();
  if(lobbyUnsub) lobbyRef.off('value',lobbyUnsub);
  if(chatUnsub) chatRef.off('child_added',chatUnsub);
  joined=false; playerName=""; lobbyName=""; playerHand=[]; pile=[]; currentTurn="";
  selectedCards.clear();
  document.getElementById('game-container-wrapper').style.display='none';
  document.getElementById('lobby-container').style.display='block';
  updateUI();
}
async function sendChatMessage(){
  if(!joined||!chatRef)return;
  const input=document.getElementById('chat-input'); const text=input.value.trim();
  if(!text)return;
  await chatRef.push({player:playerName,text,ts:Date.now()});
  input.value='';
}
function appendChatMessage(msg){
  const c=document.getElementById('chat-container');
  const d=document.createElement('div');
  d.textContent=`${msg.player}: ${msg.text}`; c.appendChild(d); c.scrollTop=c.scrollHeight;
}
function updateUI(players={},winner=null){
  const cont=document.getElementById('game-container'); cont.innerHTML='';
  playerHand.forEach((c,i)=>{const d=document.createElement('div'); d.textContent=c; d.className='card'; if(selectedCards.has(i))d.classList.add('selected'); d.onclick=()=>toggleCard(i); cont.appendChild(d);});
  const pileCont=document.getElementById('pile-container'); pileCont.innerHTML='';
  pile.forEach(p=>{const d=document.createElement('div'); d.textContent=p.declared+" (by "+p.player+")"; pileCont.appendChild(d);});
  const list=document.getElementById('players-list'); list.innerHTML='';
  Object.entries(players).forEach(([n,h])=>{const li=document.createElement('li'); li.textContent=`${n} - ${h.length}`; if(n===currentTurn)li.style.fontWeight='bold'; list.appendChild(li);});
  document.getElementById('game-info').textContent=`current Turn: ${currentTurn}`;
  document.getElementById('btn-play').disabled=!joined||currentTurn!==playerName||winner;
  document.getElementById('btn-draw').disabled=!joined||currentTurn!==playerName||winner;
  document.getElementById('btn-bullshit').disabled=!joined||pile.length===0||winner;
}

/* ---------------- Event Bindings ---------------- */
document.getElementById('btn-join').onclick=joinLobby;
document.getElementById('btn-play').onclick=playSelected;
document.getElementById('btn-draw').onclick=drawCard;
document.getElementById('btn-bullshit').onclick=callBS;
document.getElementById('btn-leave').onclick=leaveLobby;
document.getElementById('chat-send').onclick=sendChatMessage;
document.getElementById('chat-input').addEventListener('keydown',e=>{if(e.key==='Enter')sendChatMessage();});
</script>
</body>
</html>
